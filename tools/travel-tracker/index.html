<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dolmenwood Travel Tracker</title>
<style>
  :root {
    --bg: #1a1408;
    --panel: #211c10;
    --border: #5a4a20;
    --gold: #c9a84c;
    --gold-light: #e8c96a;
    --text: #d4c49a;
    --text-dim: #8a7a55;
    --red: #c44;
    --green: #4a8;
    --blue: #4af;
    --orange: #e87;
    --hex-hover: rgba(255,255,255,0.15);
    --hex-stroke: rgba(255,200,50,0.5);
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Georgia', serif;
    display: flex;
    height: 100vh;
    overflow: hidden;
  }

  /* â”€â”€ LOG COLUMN â”€â”€ */
  #log-col {
    width: 280px;
    min-width: 220px;
    background: var(--panel);
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }
  #log-col-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 8px 12px;
    background: #2a2010;
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
  }
  #log-col-header span {
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.07em;
    color: var(--gold);
  }
  #log-col-header button { width: auto; padding: 2px 8px; font-size: 0.7rem; margin: 0; }

  /* â”€â”€ LEFT PANEL â”€â”€ */
  #sidebar {
    width: 340px;
    min-width: 300px;
    background: var(--panel);
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }
  #sidebar-header {
    padding: 14px 16px 10px;
    border-bottom: 1px solid var(--border);
    background: #2a2010;
  }
  #sidebar-header h1 {
    font-size: 1.15rem;
    color: var(--gold-light);
    letter-spacing: 0.05em;
    text-transform: uppercase;
  }
  #sidebar-header p { font-size: 0.75rem; color: var(--text-dim); margin-top: 2px; }

  #sidebar-body {
    flex: 1;
    overflow-y: auto;
    padding: 12px;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }
  #sidebar-body::-webkit-scrollbar { width: 6px; }
  #sidebar-body::-webkit-scrollbar-track { background: var(--panel); }
  #sidebar-body::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

  .card {
    background: #2a2010;
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 10px 12px;
  }
  .card h3 {
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--gold);
    margin-bottom: 8px;
  }

  /* hex info */
  .hex-info-row { display: flex; justify-content: space-between; align-items: center; font-size: 0.82rem; margin-bottom: 3px; }
  .hex-info-row .label { color: var(--text-dim); }
  .hex-info-row .value { color: var(--text); font-weight: bold; }

  /* inputs */
  label { font-size: 0.78rem; color: var(--text-dim); display: block; margin-bottom: 2px; }
  input[type=number], select {
    width: 100%;
    background: #131006;
    border: 1px solid var(--border);
    color: var(--text);
    padding: 5px 8px;
    border-radius: 3px;
    font-size: 0.82rem;
    font-family: inherit;
    margin-bottom: 6px;
  }
  input[type=checkbox] { margin-right: 5px; accent-color: var(--gold); }
  .check-label { font-size: 0.82rem; color: var(--text); display: flex; align-items: center; margin-bottom: 4px; cursor: pointer; }

  /* TP bar */
  .tp-bar-wrap { display: flex; align-items: center; gap: 8px; margin-bottom: 4px; }
  /* TP manual spinner */
  .tp-spinner-row { display: flex; align-items: center; gap: 5px; margin-bottom: 5px; }
  .tp-spin-btn {
    width: 24px; height: 24px; padding: 0; font-size: 1rem;
    margin: 0; line-height: 1; flex-shrink: 0;
    background: #3a2c10; border: 1px solid var(--gold);
    color: var(--gold-light); border-radius: 3px; cursor: pointer;
  }
  .tp-spin-btn:hover { background: #5a4218; }
  .tp-spin-val {
    min-width: 28px; text-align: center;
    font-size: 1rem; font-weight: bold; color: var(--gold-light);
  }
  .tp-bar-bg { flex: 1; height: 8px; background: #131006; border: 1px solid var(--border); border-radius: 4px; overflow: hidden; }
  .tp-bar-fill { height: 100%; background: var(--gold); transition: width 0.3s; border-radius: 4px; }
  .tp-label { font-size: 0.8rem; color: var(--gold-light); white-space: nowrap; }

  /* terrain badge */
  .terrain-badge {
    display: inline-block;
    padding: 2px 7px;
    border-radius: 3px;
    font-size: 0.75rem;
    font-weight: bold;
    letter-spacing: 0.04em;
  }
  .t-light { background: #2a4a1a; color: #8de060; border: 1px solid #4a7a2a; }
  .t-moderate { background: #3a3010; color: #d4a840; border: 1px solid #6a5a20; }
  .t-severe { background: #4a1a0a; color: #e07050; border: 1px solid #7a3010; }
  .t-aquatic { background: #0a2a4a; color: #60c0e0; border: 1px solid #1a5a8a; }
  .t-road { background: #1a2a3a; color: #80a0c0; border: 1px solid #3a5a7a; }

  /* buttons */
  button {
    background: #3a2c10;
    border: 1px solid var(--gold);
    color: var(--gold-light);
    padding: 7px 12px;
    border-radius: 3px;
    font-family: inherit;
    font-size: 0.82rem;
    cursor: pointer;
    transition: background 0.15s;
    width: 100%;
    margin-top: 4px;
  }
  button:hover { background: #5a4218; }
  button.btn-primary {
    background: #6a4a10;
    border-color: var(--gold-light);
    font-size: 0.88rem;
    padding: 9px;
  }
  button.btn-primary:hover { background: #8a6218; }
  button:disabled { opacity: 0.4; cursor: not-allowed; }

  /* map toggle row */
  .map-toggle { display: flex; gap: 6px; flex-wrap: wrap; }
  .map-toggle button { flex: 1; padding: 5px; font-size: 0.75rem; margin-top: 0; }
  .map-toggle button.active { background: #5a4218; border-color: var(--gold-light); }

  /* day / night toggle */
  .day-night-row { display: flex; gap: 6px; margin-top: 6px; margin-bottom: 4px; }
  .dn-btn { flex: 1; padding: 5px; font-size: 0.8rem; margin-top: 0; }
  .dn-btn.active { background: #5a4218; border-color: var(--gold-light); }

  /* â”€â”€ LOG (now inside #log-col, full height) â”€â”€ */
  #log {
    flex: 1;
    overflow-y: auto;
    padding: 8px 10px;
    font-size: 0.78rem;
    line-height: 1.5;
  }
  #log::-webkit-scrollbar { width: 4px; }
  #log::-webkit-scrollbar-thumb { background: var(--border); }

  /* Travel block: groups all entries for one travel action */
  .log-block {
    border-left: 2px solid var(--border);
    padding: 4px 0 4px 8px;
    margin-bottom: 8px;
  }
  .log-block-past {
    opacity: 0.45;
    transition: opacity 0.15s;
  }
  .log-block-past:hover { opacity: 1; }

  .log-entry { margin-bottom: 3px; }

  /* Highlighted value at end of a log line â€” thin border + padding */
  .log-value {
    display: inline-block;
    border: 1px solid var(--border);
    border-radius: 3px;
    padding: 0px 5px;
    background: rgba(255,255,255,0.05);
    font-weight: bold;
  }
  .log-value.roll   { border-color: #7a6030; color: var(--gold-light); }
  .log-value.danger { border-color: #7a2020; color: #e06060; }
  .log-value.ok     { border-color: #2a6040; color: #60c080; }
  .log-value.warn   { border-color: #7a4020; color: var(--orange); }

  /* Travel button overlay on map â€” bottom center */
  #travel-btn-overlay {
    position: absolute;
    bottom: 16px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 30;
    pointer-events: all;
  }
  #travel-btn-overlay button {
    background: rgba(70, 48, 10, 0.95);
    border: 1px solid var(--gold-light);
    color: var(--gold-light);
    font-family: inherit;
    font-size: 0.9rem;
    padding: 9px 22px;
    border-radius: 4px;
    cursor: pointer;
    width: auto;
    margin: 0;
    backdrop-filter: blur(3px);
    transition: background 0.15s;
    letter-spacing: 0.03em;
  }
  #travel-btn-overlay button:hover  { background: rgba(110, 75, 15, 0.97); }
  #travel-btn-overlay button:disabled { opacity: 0.35; cursor: not-allowed; }

  .log-dim     { color: var(--text-dim); }
  .log-roll    { color: var(--gold-light); font-weight: bold; }
  .log-warn    { color: var(--orange); }
  .log-danger  { color: var(--red); }
  .log-ok      { color: var(--green); }
  .log-info    { color: var(--blue); }
  .log-section { color: var(--gold); font-weight: bold; text-transform: uppercase; font-size: 0.72rem; letter-spacing: 0.05em; }

  /* â”€â”€ MAP AREA â”€â”€ */
  #map-area {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    background: #0d0d0d;
    position: relative;  /* anchor for absolute overlays */
  }
  #map-toolbar {
    padding: 6px 12px;
    background: #18140c;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 12px;
    flex-wrap: wrap;
  }
  #map-toolbar span { font-size: 0.78rem; color: var(--text-dim); }
  #map-toolbar strong { color: var(--gold-light); }
  #map-container {
    flex: 1;
    overflow: auto;
    position: relative;
    cursor: grab;
    user-select: none;
  }
  #map-container.panning {
    cursor: grabbing;
  }
  #map-container::-webkit-scrollbar { width: 8px; height: 8px; }
  #map-container::-webkit-scrollbar-track { background: #0d0d0d; }
  #map-container::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
  #map-wrapper {
    position: relative;
    display: inline-block;
  }
  #map-img {
    display: block;
    max-width: none;
  }
  #hex-svg {
    position: absolute;
    top: 0; left: 0;
    pointer-events: all;
    overflow: visible;
  }
  /* base highlight layers â€” invisible by default */
  .hex-hl-outer { fill: transparent; stroke: none; pointer-events: none; }
  .hex-hl-inner { fill: transparent; stroke: none; pointer-events: none; }

  /* Current hex: thick orange outer + thin yellow inner */
  .hex-hl-outer.current-outer {
    fill: rgba(255, 130, 0, 0.22);
    stroke: #d06000;
    stroke-width: 28;
  }
  .hex-hl-inner.current-inner {
    fill: transparent;
    stroke: #ffd040;
    stroke-width: 8;
  }
  /* Target hex: thick dark-green outer + thin light-green inner */
  .hex-hl-outer.target-outer {
    fill: rgba(20, 150, 50, 0.18);
    stroke: #1a7a30;
    stroke-width: 28;
  }
  .hex-hl-inner.target-inner {
    fill: transparent;
    stroke: #70ff70;
    stroke-width: 8;
  }

  .hex-poly {
    fill: transparent;
    stroke: transparent;
    cursor: pointer;
    transition: fill 0.1s, stroke 0.1s;
  }
  .hex-poly:hover {
    fill: var(--hex-hover);
    stroke: var(--hex-stroke);
    stroke-width: 8;
  }
  .hex-label {
    fill: rgba(255,255,255,0.35);
    font-size: 12px;
    font-family: sans-serif;
    pointer-events: none;
    text-anchor: middle;
    dominant-baseline: middle;
  }
  .hex-label.current { fill: #ffd040; font-weight: bold; font-size: 18px; }
  .hex-label.target  { fill: #70ff70; font-weight: bold; font-size: 18px; }

  /* zoom controls â€” fixed to map-area, always visible */
  #zoom-controls {
    position: absolute;
    bottom: 12px;
    right: 12px;
    display: flex;
    flex-direction: column;
    gap: 4px;
    z-index: 30;
    pointer-events: all;
  }
  #zoom-controls button {
    width: 32px;
    height: 32px;
    padding: 0;
    font-size: 1.1rem;
    margin: 0;
    background: rgba(42,32,16,0.92);
    backdrop-filter: blur(2px);
  }

  /* calibration panel â€” fixed to map-area, always visible */
  #cal-panel {
    position: absolute;
    top: 44px;
    right: 10px;
    background: rgba(20,14,4,0.96);
    border: 1px solid var(--gold);
    border-radius: 5px;
    padding: 10px 13px;
    z-index: 31;
    width: 260px;
    font-size: 0.75rem;
    display: none;
    backdrop-filter: blur(2px);
  }
  #cal-panel.open { display: block; }
  #cal-panel h4 { color: var(--gold-light); margin-bottom: 8px; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.06em; }
  .cal-row { display: flex; align-items: center; gap: 5px; margin-bottom: 5px; }
  .cal-row label { color: var(--text-dim); width: 76px; flex-shrink: 0; font-size: 0.72rem; }
  .cal-row input[type=range] { flex: 1; accent-color: var(--gold); height: 4px; min-width: 0; }
  .cal-row input[type=number] {
    width: 52px; flex-shrink: 0;
    background: #131006; border: 1px solid var(--border);
    color: var(--gold-light); padding: 2px 4px;
    border-radius: 3px; font-size: 0.72rem; font-family: monospace;
    text-align: right;
  }
  .cal-row input[type=number]:focus { border-color: var(--gold); outline: none; }
  #cal-toggle {
    position: absolute;
    top: 10px;
    right: 10px;
    z-index: 32;
    width: auto;
    padding: 4px 10px;
    font-size: 0.75rem;
    margin: 0;
    background: rgba(42,32,16,0.92);
    backdrop-filter: blur(2px);
  }
  #cal-output {
    background: #0d0a04;
    border: 1px solid var(--border);
    border-radius: 3px;
    padding: 5px 7px;
    font-size: 0.68rem;
    color: var(--text-dim);
    margin-top: 6px;
    font-family: monospace;
    line-height: 1.5;
    white-space: pre;
  }

  /* weather badge */
  .weather-flag {
    display: inline-block;
    padding: 1px 5px;
    border-radius: 2px;
    font-size: 0.7rem;
    margin-left: 3px;
  }
  .flag-I { background: #5a1010; color: #ff8080; border: 1px solid #8a2020; }
  .flag-V { background: #1a1a5a; color: #8080ff; border: 1px solid #2a2a8a; }
  .flag-W { background: #102a3a; color: #60b0d0; border: 1px solid #1a4a6a; }

  /* scroll hint */
  .hint { font-size: 0.72rem; color: var(--text-dim); font-style: italic; }

  /* calendar sync status */
  .sync-ok   { color: var(--green); }
  .sync-err  { color: var(--red); }
  .sync-off  { color: var(--text-dim); }
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SIDEBAR -->
<div id="sidebar">
  <div id="sidebar-header">
    <h1>Dolmenwood Travel</h1>
    <p>Referee Procedure Tracker</p>
  </div>

  <div id="sidebar-body">

    <!-- MAP SWITCH -->
    <div class="card">
      <h3>Map Layer</h3>
      <div class="map-toggle">
        <button onclick="switchMap('blank')" id="btn-blank">Blank</button>
        <button onclick="switchMap('player')" id="btn-player">Player's</button>
        <button class="active" onclick="switchMap('referee')" id="btn-referee">Referee</button>
        <button onclick="switchMap('vtt')" id="btn-vtt">VTT</button>
        <button onclick="switchMap('vtt-s')" id="btn-vtt-s">VTT+Settlements</button>
      </div>
    </div>

    <!-- PARTY STATUS -->
    <div class="card" id="card-hex">
      <h3>Position</h3>
      <div class="hex-info-row">
        <span class="label">Current Hex</span>
        <span class="value" id="disp-current">â€”</span>
      </div>
      <div class="hex-info-row">
        <span class="label">Terrain</span>
        <span id="disp-terrain">â€”</span>
      </div>
      <div class="hex-info-row">
        <span class="label">Region</span>
        <span class="value" id="disp-region">â€”</span>
      </div>
      <div class="hex-info-row">
        <span class="label">Lost chance</span>
        <span class="value" id="disp-lost">â€”</span>
      </div>
      <div class="hex-info-row">
        <span class="label">Encounter chance</span>
        <span class="value" id="disp-enc">â€”</span>
      </div>
      <hr style="border-color:#3a2c10; margin:6px 0;">
      <div class="hex-info-row">
        <span class="label">Target Hex</span>
        <span class="value" id="disp-target">â€”</span>
      </div>
      <div class="hex-info-row">
        <span class="label">Target Terrain</span>
        <span id="disp-target-terrain">â€”</span>
      </div>
      <div class="hex-info-row">
        <span class="label">TP cost (target)</span>
        <span class="value" id="disp-tp-cost">â€”</span>
      </div>
      <p class="hint" style="margin-top:6px">Click map: 1st click = current, 2nd = target</p>
    </div>

    <!-- PARTY SETTINGS -->
    <div class="card">
      <h3>Party Settings</h3>
      <label>Base Speed (feet/turn)</label>
      <input type="number" id="inp-speed" value="40" min="10" max="120" step="10">
      <label>Season</label>
      <select id="inp-season">
        <option value="spring">Spring</option>
        <option value="summer">Summer</option>
        <option value="autumn">Autumn</option>
        <option value="winter">Winter</option>
        <option value="hitching">Unseason: Hitching</option>
        <option value="vague">Unseason: Vague</option>
      </select>
      <label class="check-label"><input type="checkbox" id="chk-road"> Road / Track</label>
      <label class="check-label"><input type="checkbox" id="chk-forced"> Forced March (+50% TP, exhaustion)</label>
      <label class="check-label"><input type="checkbox" id="chk-hunter"> Hunter in party (3-in-6 navigation)</label>
      <label class="check-label"><input type="checkbox" id="chk-guide"> Hired Guide (4-in-6 navigation)</label>
      <!-- Day / Night -->
      <div class="day-night-row">
        <button id="btn-day"   class="dn-btn active" onclick="setTimeOfDay('day')">â˜€ Day</button>
        <button id="btn-night" class="dn-btn"        onclick="setTimeOfDay('night')">ğŸŒ™ Night</button>
      </div>
      <label class="check-label" id="fire-row" style="display:none">
        <input type="checkbox" id="chk-fire" checked> Camp fire lit
      </label>
    </div>

    <!-- CALENDAR SYNC -->
    <div class="card" id="card-cal-sync">
      <h3>Campaign Day</h3>
      <div class="hex-info-row">
        <span class="label">Date</span>
        <span class="value" id="disp-cal-date">â€”</span>
      </div>
      <div class="hex-info-row">
        <span class="label">Season</span>
        <span class="value" id="disp-cal-season">â€”</span>
      </div>
      <label class="check-label" style="margin-top:6px">
        <input type="checkbox" id="chk-cal-sync"> Sync with Calendar
      </label>
      <div id="cal-sync-status" style="font-size:0.72rem;color:var(--text-dim);margin-top:3px;display:none;"></div>
    </div>

    <!-- TRAVEL POINTS -->
    <div class="card">
      <h3>Travel Points Today</h3>
      <div class="tp-bar-wrap">
        <div class="tp-bar-bg"><div class="tp-bar-fill" id="tp-bar" style="width:100%"></div></div>
        <span class="tp-label" id="tp-label">8 / 8</span>
      </div>
      <div class="tp-spinner-row">
        <span class="label" style="flex:1">Adjust TP</span>
        <button class="tp-spin-btn" onclick="adjustTP(-1)">âˆ’</button>
        <span id="tp-current-disp" class="tp-spin-val">8</span>
        <button class="tp-spin-btn" onclick="adjustTP(+1)">+</button>
      </div>
      <div class="hex-info-row">
        <span class="label">Weather today</span>
        <span id="disp-weather">â€”</span>
      </div>
      <button onclick="runWeather()">Roll Weather (2d6)</button>
      <button onclick="resetTP()">Reset TP (New Day)</button>
    </div>

  </div><!-- /sidebar-body -->
</div><!-- /sidebar -->

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• LOG COLUMN -->
<div id="log-col">
  <div id="log-col-header">
    <span>Session Log</span>
    <button onclick="clearLog()">Clear</button>
  </div>
  <div id="log"></div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MAP -->
<div id="map-area">
  <div id="map-toolbar">
    <span>Click on map to select hexes &nbsp;|&nbsp; <strong>Yellow</strong> = current &nbsp;|&nbsp; <strong>Green</strong> = target</span>
    <span id="toolbar-hover"></span>
  </div>
  <div id="map-container">
    <div id="map-wrapper">
      <img id="map-img" src="../../Maps/Referee/Dolmenwood Referee's Hex Map.png" alt="Dolmenwood Map">
      <svg id="hex-svg"></svg>
    </div>
  </div>

  <!-- TRAVEL BUTTON â€” bottom center of map, always visible -->
  <div id="travel-btn-overlay">
    <button id="btn-travel" onclick="runTravel()" disabled>Travel to Target Hex â†’</button>
  </div>

  <!-- ZOOM CONTROLS â€” anchored to #map-area, always visible -->
  <div id="zoom-controls">
    <button onclick="zoomIn()">+</button>
    <button onclick="zoomOut()">âˆ’</button>
    <button onclick="zoomReset()" title="Reset zoom">âŸ³</button>
  </div>

  <!-- CALIBRATION PANEL â€” anchored to #map-area, always visible -->
  <button id="cal-toggle" onclick="toggleCal()">âš™ Kalibracja</button>
  <div id="cal-panel">
    <h4>âš™ Kalibracja siatki</h4>

    <div class="cal-row">
      <label>originX</label>
      <input type="range"  id="c-ox"  min="0"    max="800"  step="1"  value="448" oninput="syncNum('c-ox','n-ox');applyCalibration()">
      <input type="number" id="n-ox"  min="0"    max="800"  step="1"  value="448" oninput="syncRange('n-ox','c-ox');applyCalibration()">
    </div>
    <div class="cal-row">
      <label>originY</label>
      <input type="range"  id="c-oy"  min="0"    max="800"  step="1"  value="275" oninput="syncNum('c-oy','n-oy');applyCalibration()">
      <input type="number" id="n-oy"  min="0"    max="800"  step="1"  value="275" oninput="syncRange('n-oy','c-oy');applyCalibration()">
    </div>
    <div class="cal-row">
      <label>hexR</label>
      <input type="range"  id="c-r"   min="60"   max="400"  step="1"    value="153"   oninput="syncNum('c-r','n-r');applyCalibration()">
      <input type="number" id="n-r"   min="60"   max="400"  step="0.5"  value="153"   oninput="syncRange('n-r','c-r');applyCalibration()">
    </div>
    <div class="cal-row">
      <label>colW</label>
      <input type="range"  id="c-cw"  min="80"   max="600"  step="1"    value="233"   oninput="syncNum('c-cw','n-cw');applyCalibration()">
      <input type="number" id="n-cw"  min="80"   max="600"  step="0.5"  value="232.5" oninput="syncRange('n-cw','c-cw');applyCalibration()">
    </div>
    <div class="cal-row">
      <label>rowH</label>
      <input type="range"  id="c-rh"  min="80"   max="600"  step="1"    value="268"   oninput="syncNum('c-rh','n-rh');applyCalibration()">
      <input type="number" id="n-rh"  min="80"   max="600"  step="0.1"  value="268.3" oninput="syncRange('n-rh','c-rh');applyCalibration()">
    </div>
    <div class="cal-row">
      <label>evenOffset</label>
      <input type="range"  id="c-eo"  min="-400" max="400"  step="1"  value="135" oninput="syncNum('c-eo','n-eo');applyCalibration()">
      <input type="number" id="n-eo"  min="-400" max="400"  step="1"  value="135" oninput="syncRange('n-eo','c-eo');applyCalibration()">
    </div>
    <div class="cal-row">
      <label>hexRot (Â°)</label>
      <input type="range"  id="c-rot" min="0"    max="90"   step="5"  value="0"   oninput="syncNum('c-rot','n-rot');applyCalibration()">
      <input type="number" id="n-rot" min="0"    max="90"   step="1"  value="0"   oninput="syncRange('n-rot','c-rot');applyCalibration()">
    </div>

    <div id="cal-output">Porusz suwakiem aby zobaczyÄ‡ wartoÅ›ci</div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SCRIPTS -->
<!-- Calendar data + state (for sync) -->
<script src="../calendar/js/calendar-data.js"></script>
<script src="../calendar/js/calendar-state.js"></script>
<!-- Data layers (no dependencies) -->
<script src="js/data-hexes.js"></script>
<script src="js/data-weather.js"></script>
<script src="js/data-encounters.js"></script>
<!-- Utilities -->
<script src="js/dice.js"></script>
<!-- Feature modules (depend on data + dice) -->
<script src="js/weather.js"></script>
<script src="js/encounters.js"></script>
<script src="js/travel.js"></script>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HEX GRID GEOMETRY
// The Dolmenwood map uses a FLAT-TOP offset hex grid.
// Odd columns (01,03,05â€¦) are baseline; even columns (02,04,06â€¦)
// are shifted UP by rowH/2.
// Grid: columns 01â€“19, rows 01â€“12 (not all cells exist).
// Calibrated to the blank map image at native resolution.
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const HEX_CONFIG = {
  // Native image: 5080 Ã— 3627 px
  // POINTY-TOP hex grid, 19 cols Ã— 12 rows.
  // ODD columns (01,03,05â€¦): baseline row position.
  // EVEN columns (02,04,06â€¦): shifted DOWN by rowH/2.
  //
  // Calibrated by pixel-level scan of the blank map PNG:
  //   Horizontal edge-pair at y=200 â†’ col centers every 232px
  //   col01 center x = 215 (midpoint of pair 95..335)
  //   hexR = (252/2) / cos(0) from pointy-top equator = 146
  //   hex01 center y = 342 (derived from slanted-edge intersection)
  //   rowH = 2*hexR = 291 (pointy-top)
  //   evenOffset = +146 (even cols shift down by rowH/2)

  originX: 448,
  originY: 275,
  hexR: 153,
  colW: 232.5,
  rowH: 268.3,
  evenOffset: 135,   // positive = even cols shift DOWN
  hexRot: 0,         // 0=flat-top, 90=pointy-top â€” tune with calibration panel
  imgW: 5080,
  imgH: 3627,
  cols: 19,
  rows: 12,
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let state = {
  currentHex: null,
  targetHex: null,
  clickPhase: 1, // 1 = selecting current, 2 = selecting target
  tpMax: 8,
  tpLeft: 8,
  weatherFlags: { I: false, V: false, W: false },
  weatherText: null,
  scale: 1.0,
  isNight: false,
  hasFire: true,
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HEX GRID MATH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function hexCenter(col, row) {
  // col: 1-based, row: 1-based
  // Pointy-top grid: even columns shift DOWN by evenOffset (= rowH/2)
  const c = HEX_CONFIG;
  const x = c.originX + (col - 1) * c.colW;
  const y = c.originY + (row - 1) * c.rowH + (col % 2 === 0 ? c.evenOffset : 0);
  return { x, y };
}

function hexVertices(cx, cy) {
  const r   = HEX_CONFIG.hexR;
  const rot = HEX_CONFIG.hexRot !== undefined ? HEX_CONFIG.hexRot : 90;
  // rot=0  â†’ flat-top  (first vertex pointing RIGHT)
  // rot=90 â†’ pointy-top (first vertex pointing UP)
  const pts = [];
  for (let i = 0; i < 6; i++) {
    const angle = Math.PI / 180 * (60 * i + rot);
    pts.push([cx + r * Math.cos(angle), cy - r * Math.sin(angle)]);
  }
  return pts;
}

function hexId(col, row) {
  return String(col).padStart(2,'0') + String(row).padStart(2,'0');
}

function hexFromId(id) {
  return { col: parseInt(id.slice(0,2)), row: parseInt(id.slice(2,4)) };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SVG OVERLAY GENERATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function makePoly(pts, cls, id) {
  const p = document.createElementNS('http://www.w3.org/2000/svg','polygon');
  p.setAttribute('points', pts);
  p.setAttribute('class', cls);
  if (id) p.setAttribute('data-hex', id);
  return p;
}

function buildOverlay() {
  const img = document.getElementById('map-img');
  const svg = document.getElementById('hex-svg');
  const c = HEX_CONFIG;

  const W = img.naturalWidth  || c.imgW;
  const H = img.naturalHeight || c.imgH;
  svg.setAttribute('width',   W);
  svg.setAttribute('height',  H);
  svg.setAttribute('viewBox', `0 0 ${W} ${H}`);
  svg.innerHTML = '';

  // Layer groups: outer highlights behind, inner highlights, clickable on top
  const gOuter  = document.createElementNS('http://www.w3.org/2000/svg','g');
  gOuter.setAttribute('id','layer-outer');
  const gInner  = document.createElementNS('http://www.w3.org/2000/svg','g');
  gInner.setAttribute('id','layer-inner');
  const gHit    = document.createElementNS('http://www.w3.org/2000/svg','g');
  gHit.setAttribute('id','layer-hit');
  const gLabels = document.createElementNS('http://www.w3.org/2000/svg','g');
  gLabels.setAttribute('id','layer-labels');
  svg.appendChild(gOuter);
  svg.appendChild(gInner);
  svg.appendChild(gHit);
  svg.appendChild(gLabels);

  for (let col = 1; col <= c.cols; col++) {
    for (let row = 1; row <= c.rows; row++) {
      const id = hexId(col, row);
      const { x, y } = hexCenter(col, row);
      const verts = hexVertices(x, y);
      const pts = verts.map(v => v.join(',')).join(' ');

      // Outer highlight polygon (thick stroke, hidden by default)
      const outer = makePoly(pts, 'hex-hl-outer', null);
      outer.setAttribute('data-hl-outer', id);
      gOuter.appendChild(outer);

      // Inner highlight polygon (thin stroke, hidden by default)
      const inner = makePoly(pts, 'hex-hl-inner', null);
      inner.setAttribute('data-hl-inner', id);
      gInner.appendChild(inner);

      // Clickable polygon (transparent, captures events)
      const poly = makePoly(pts, 'hex-poly', id);
      poly.addEventListener('click', () => onHexClick(id));
      poly.addEventListener('mouseenter', () => onHexHover(id));
      poly.addEventListener('mouseleave', () => onHexLeave());
      gHit.appendChild(poly);

      // Label
      const label = document.createElementNS('http://www.w3.org/2000/svg','text');
      label.setAttribute('x', x);
      label.setAttribute('y', y + 1);
      label.setAttribute('class', 'hex-label');
      label.setAttribute('data-label', id);
      label.textContent = id;
      gLabels.appendChild(label);
    }
  }
}

function setHexHighlight(id, type) {
  // type: 'current' | 'target' | null
  const outer = document.querySelector(`[data-hl-outer="${id}"]`);
  const inner = document.querySelector(`[data-hl-inner="${id}"]`);
  const label = document.querySelector(`[data-label="${id}"]`);
  if (!outer) return;
  // clear
  outer.setAttribute('class','hex-hl-outer');
  inner.setAttribute('class','hex-hl-inner');
  if (label) { label.classList.remove('current','target'); }
  if (type === 'current') {
    outer.classList.add('current-outer');
    inner.classList.add('current-inner');
    if (label) label.classList.add('current');
  } else if (type === 'target') {
    outer.classList.add('target-outer');
    inner.classList.add('target-inner');
    if (label) label.classList.add('target');
  }
}

function refreshOverlay() {
  // Clear all highlights
  document.querySelectorAll('.hex-hl-outer').forEach(p => {
    p.setAttribute('class','hex-hl-outer');
  });
  document.querySelectorAll('.hex-hl-inner').forEach(p => {
    p.setAttribute('class','hex-hl-inner');
  });
  document.querySelectorAll('[data-label]').forEach(l => {
    l.classList.remove('current','target');
  });
  if (state.currentHex) setHexHighlight(state.currentHex, 'current');
  if (state.targetHex)  setHexHighlight(state.targetHex,  'target');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INTERACTION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function onHexClick(id) {
  if (state.clickPhase === 1) {
    state.currentHex = id;
    state.targetHex = null;
    state.clickPhase = 2;
    log(`<span class="log-info">[Click] Current hex set to <strong>${id}</strong></span>`);
  } else {
    if (id === state.currentHex) {
      // clicking same hex resets target phase
      state.targetHex = null;
      state.clickPhase = 2;
    } else {
      state.targetHex = id;
      state.clickPhase = 1; // next click sets a new current
      log(`<span class="log-info">[Click] Target hex set to <strong>${id}</strong></span>`);
    }
  }
  updateSidebar();
  refreshOverlay();
}

function onHexHover(id) {
  const h = HEXES[id];
  const desc = h ? `${id} â€“ ${h.t}, ${h.r}` : `${id} â€“ (no data)`;
  document.getElementById('toolbar-hover').textContent = desc;
}
function onHexLeave() {
  document.getElementById('toolbar-hover').textContent = '';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SIDEBAR UPDATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateSidebar() {
  const ch = state.currentHex;
  const th = state.targetHex;
  const hc = ch ? HEXES[ch] : null;
  const ht = th ? HEXES[th] : null;

  document.getElementById('disp-current').textContent = ch || 'â€”';
  document.getElementById('disp-terrain').innerHTML = hc ? terrainBadge(hc) : 'â€”';
  document.getElementById('disp-region').textContent = hc ? hc.r : 'â€”';
  document.getElementById('disp-lost').textContent = hc ? `${hc.lc}-in-6` : 'â€”';
  document.getElementById('disp-enc').textContent = hc ? `${hc.ec}-in-6` : 'â€”';

  document.getElementById('disp-target').textContent = th || 'â€”';
  document.getElementById('disp-target-terrain').innerHTML = ht ? terrainBadge(ht) : 'â€”';

  // TP cost for target
  let tpCost = 'â€”';
  if (ht) {
    const onRoad = document.getElementById('chk-road').checked;
    let cost = onRoad ? 2 : ht.tp;
    if (state.weatherFlags.I) cost += 2;
    tpCost = cost;
  }
  document.getElementById('disp-tp-cost').textContent = tpCost === 'â€”' ? 'â€”' : `${tpCost} TP`;

  // TP bar
  updateTPBar();

  // travel button
  const canTravel = ch && th && state.tpLeft > 0;
  document.getElementById('btn-travel').disabled = !canTravel;
}

function terrainBadge(h) {
  const cls = { light:'t-light', moderate:'t-moderate', severe:'t-severe', aquatic:'t-aquatic', road:'t-road' };
  return `<span class="terrain-badge ${cls[h.tc] || 't-light'}">${h.t}</span>`;
}

function updateTPBar() {
  const max = state.tpMax;
  const left = Math.max(0, state.tpLeft);
  const pct = max > 0 ? Math.min(100, (left / max) * 100) : 0;
  document.getElementById('tp-bar').style.width = pct + '%';
  document.getElementById('tp-label').textContent = `${left} / ${max}`;
  document.getElementById('tp-current-disp').textContent = left;
  // color
  const bar = document.getElementById('tp-bar');
  bar.style.background = pct > 50 ? '#c9a84c' : pct > 25 ? '#e87040' : '#c04040';
}

function adjustTP(delta) {
  state.tpLeft = Math.max(0, Math.min(state.tpMax, state.tpLeft + delta));
  updateTPBar();
  updateSidebar();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LOG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _logBlock = null;  // current open travel block

function logBlockOpen() {
  // Dim ALL existing blocks immediately
  document.querySelectorAll('.log-block').forEach(b => b.classList.add('log-block-past'));
  const div = document.getElementById('log');
  _logBlock = document.createElement('div');
  _logBlock.className = 'log-block';   // no 'past' â€” this one is active
  div.appendChild(_logBlock);
}

function logBlockClose() {
  // newest block stays bright until next travel
  _logBlock = null;
}

function log(html) {
  const container = _logBlock || document.getElementById('log');
  const entry = document.createElement('div');
  entry.className = 'log-entry';
  entry.innerHTML = html;
  container.appendChild(entry);
  document.getElementById('log').scrollTop = document.getElementById('log').scrollHeight;
}

// logR: dim label text, highlighted value after â†’
// text before â†’ (if any) is dimmed, the part after â†’ gets the coloured border box.
// If no â†’ in html, the whole text gets the border.
function logR(type, html) {
  let inner;
  const arrowIdx = html.lastIndexOf('â†’');
  if (arrowIdx !== -1) {
    const label = html.slice(0, arrowIdx + 1);  // includes â†’
    const value = html.slice(arrowIdx + 1).trim();
    inner = `<span class="log-dim">${label}</span> <span class="log-value ${type}">${value}</span>`;
  } else {
    inner = `<span class="log-value ${type}">${html}</span>`;
  }
  log(inner);
}

function clearLog() {
  document.getElementById('log').innerHTML = '';
  _logBlock = null;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MAP SWITCHER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const MAPS = {
  blank:   '../../Maps/Players/Dolmenwood Blank Hex Map.png',
  player:  '../../Maps/Players/Dolmenwood Player\'s Map.png',
  referee: '../../Maps/Referee/Dolmenwood Referee\'s Hex Map.png',
  vtt:     '../../Maps/Referee/Dolmenwood VTT Hex Map.png',
  'vtt-s': '../../Maps/Referee/Dolmenwood VTT Hex Map Settlements.png',
};
let currentMapKey = 'blank';

function switchMap(key) {
  if (!MAPS[key]) return;
  currentMapKey = key;
  document.getElementById('map-img').src = MAPS[key];
  document.querySelectorAll('.map-toggle button').forEach(b => b.classList.remove('active'));
  const btn = document.getElementById('btn-' + key);
  if (btn) btn.classList.add('active');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ZOOM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function applyScale(s) {
  state.scale = Math.max(0.3, Math.min(3.0, s));
  document.getElementById('map-wrapper').style.transform = `scale(${state.scale})`;
  document.getElementById('map-wrapper').style.transformOrigin = 'top left';
}
function zoomIn()    { applyScale(state.scale + 0.15); }
function zoomOut()   { applyScale(state.scale - 0.15); }
function zoomReset() { fitMap(); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CALIBRATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleCal() {
  document.getElementById('cal-panel').classList.toggle('open');
}

// Sync slider â†’ number field
function syncNum(rangeId, numberId) {
  document.getElementById(numberId).value = document.getElementById(rangeId).value;
}
// Sync number field â†’ slider
function syncRange(numberId, rangeId) {
  document.getElementById(rangeId).value = document.getElementById(numberId).value;
}

function applyCalibration() {
  // Always read from the number fields (source of truth)
  const ox  = +document.getElementById('n-ox').value;
  const oy  = +document.getElementById('n-oy').value;
  const r   = +document.getElementById('n-r').value;
  const cw  = +document.getElementById('n-cw').value;
  const rh  = +document.getElementById('n-rh').value;
  const eo  = +document.getElementById('n-eo').value;
  const rot = +document.getElementById('n-rot').value;

  // Apply to HEX_CONFIG
  HEX_CONFIG.originX    = ox;
  HEX_CONFIG.originY    = oy;
  HEX_CONFIG.hexR       = r;
  HEX_CONFIG.colW       = cw;
  HEX_CONFIG.rowH       = rh;
  HEX_CONFIG.evenOffset = eo;
  HEX_CONFIG.hexRot     = rot;

  buildOverlay();
  refreshOverlay();

  // Show current values for copy-paste
  document.getElementById('cal-output').textContent =
    `originX: ${ox},\noriginY: ${oy},\nhexR: ${r},\ncolW: ${cw},\nrowH: ${rh},\nevenOffset: ${eo},\nhexRot: ${rot}`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MAP PAN (drag to scroll)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(function() {
  let isPanning = false;
  let startX, startY, scrollLeft, scrollTop;
  // drag threshold: if mouse moves more than this many px, treat as pan not click
  const DRAG_THRESHOLD = 6;
  let moved = false;

  function onMouseDown(e) {
    if (e.button !== 0) return;       // left button only
    const container = document.getElementById('map-container');
    isPanning  = true;
    moved      = false;
    startX     = e.clientX;
    startY     = e.clientY;
    scrollLeft = container.scrollLeft;
    scrollTop  = container.scrollTop;
    container.classList.add('panning');
    e.preventDefault();
  }

  function onMouseMove(e) {
    if (!isPanning) return;
    const dx = e.clientX - startX;
    const dy = e.clientY - startY;
    if (!moved && Math.hypot(dx, dy) > DRAG_THRESHOLD) moved = true;
    if (moved) {
      const container = document.getElementById('map-container');
      container.scrollLeft = scrollLeft - dx;
      container.scrollTop  = scrollTop  - dy;
    }
  }

  function onMouseUp(e) {
    if (!isPanning) return;
    isPanning = false;
    document.getElementById('map-container').classList.remove('panning');
    // If barely moved, let the click on the SVG hex go through normally.
    // If dragged, suppress the click so hex doesn't get selected.
    if (moved) {
      e.stopPropagation();
      // also swallow the upcoming click event once
      document.getElementById('map-container').addEventListener('click', absorbClick, { capture: true, once: true });
    }
  }

  function absorbClick(e) {
    e.stopPropagation();
    e.preventDefault();
  }

  window.addEventListener('load', () => {
    const container = document.getElementById('map-container');
    container.addEventListener('mousedown', onMouseDown);
    window.addEventListener('mousemove', onMouseMove);
    window.addEventListener('mouseup',   onMouseUp);
  });
})();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DAY / NIGHT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setTimeOfDay(mode) {
  state.isNight = (mode === 'night');
  document.getElementById('btn-day').classList.toggle('active', !state.isNight);
  document.getElementById('btn-night').classList.toggle('active', state.isNight);
  const fireRow = document.getElementById('fire-row');
  fireRow.style.display = state.isNight ? 'flex' : 'none';
  state.hasFire = document.getElementById('chk-fire').checked;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CALENDAR SYNC
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let calSyncEnabled = false;
let calState = null;  // last fetched calendar state

const SEASON_MAP = {
  winter: 'winter',
  spring: 'spring',
  summer: 'summer',
  autumn: 'autumn',
};

// Map calendar season to travel-tracker season select value
const CAL_SEASON_TO_SELECT = {
  winter: 'winter',
  spring: 'spring',
  summer: 'summer',
  autumn: 'autumn',
};

function calDateLabel(st) {
  if (!st) return 'â€”';
  const months = (typeof MONTHS !== 'undefined') ? MONTHS : window.MONTHS;
  if (!months) return '(no MONTHS)';
  const m = months[st.month - 1];
  if (!m) return `(bad month: ${st.month})`;
  const day = st.day;
  const suffix = ['th','st','nd','rd'];
  const v = day % 100;
  const ord = day + (suffix[(v-20)%10] || suffix[v] || suffix[0]);
  return `${ord} ${m.name}, Y${st.year || 1}`;
}

function calSeasonLabel(st) {
  if (!st) return 'â€”';
  const months = (typeof MONTHS !== 'undefined') ? MONTHS : window.MONTHS;
  if (!months) return 'â€”';
  const m = months[st.month - 1];
  if (!m) return 'â€”';
  return m.season.charAt(0).toUpperCase() + m.season.slice(1);
}

function applyCalState(st) {
  calState = st;
  document.getElementById('disp-cal-date').textContent = calDateLabel(st);
  document.getElementById('disp-cal-season').textContent = calSeasonLabel(st);

  if (calSyncEnabled && st) {
    // Sync season selector
    const season = MONTHS[st.month - 1]?.season;
    const sel = document.getElementById('inp-season');
    if (season && CAL_SEASON_TO_SELECT[season]) {
      sel.value = CAL_SEASON_TO_SELECT[season];
    }
    // Sync weather flags if calendar has weather set
    if (st.weatherFlags) {
      state.weatherFlags = { ...st.weatherFlags };
      updateWeatherDisplay();
    }
  }
}

function updateWeatherDisplay() {
  // Update the "weather today" display in the TP card
  const disp = document.getElementById('disp-weather');
  if (calState && calState.weatherText) {
    let flags = '';
    if (state.weatherFlags.I) flags += ' <span class="weather-flag flag-I">I</span>';
    if (state.weatherFlags.V) flags += ' <span class="weather-flag flag-V">V</span>';
    if (state.weatherFlags.W) flags += ' <span class="weather-flag flag-W">W</span>';
    disp.innerHTML = calState.weatherText + flags;
  }
  updateSidebar();
}

function setSyncStatus(msg, cls) {
  const el = document.getElementById('cal-sync-status');
  el.style.display = msg ? 'block' : 'none';
  el.innerHTML = `<span class="${cls}">${msg}</span>`;
}

async function fetchAndApplyCalState() {
  setSyncStatus('Syncingâ€¦', 'sync-off');
  try {
    const { state: st, fromServer } = await fetchState();
    applyCalState(st);
    setSyncStatus(fromServer ? 'âœ“ Synced with server' : 'âœ“ Loaded from local storage', 'sync-ok');
  } catch(e) {
    setSyncStatus('âœ— Sync failed', 'sync-err');
  }
}

function onCalSyncToggle() {
  calSyncEnabled = document.getElementById('chk-cal-sync').checked;
  const statusEl = document.getElementById('cal-sync-status');
  if (calSyncEnabled) {
    fetchAndApplyCalState();
    statusEl.style.display = 'block';
  } else {
    setSyncStatus('Sync off', 'sync-off');
  }
}

// Advance calendar day when "New Day" is pressed (if sync on)
async function advanceCalendarDay() {
  if (!calSyncEnabled || !calState) return;
  const newSt = advanceDay(calState);
  // Save locally (no referee token here â€” travel tracker is read/write local only)
  saveState(newSt);
  applyCalState(newSt);
  setSyncStatus('âœ“ Day advanced (local only)', 'sync-ok');
  log(`<span class="log-info">Calendar: day advanced to ${calDateLabel(newSt)}</span>`);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function fitMap() {
  const container = document.getElementById('map-container');
  const img = document.getElementById('map-img');
  const cW = container.clientWidth;
  const cH = container.clientHeight;
  const iW = img.naturalWidth;
  const iH = img.naturalHeight;
  if (!iW || !iH) return;
  const scale = Math.min(cW / iW, cH / iH);
  applyScale(scale);
}

window.addEventListener('load', () => {
  const img = document.getElementById('map-img');
  const doInit = () => {
    const svg = document.getElementById('hex-svg');
    svg.style.width = img.naturalWidth + 'px';
    svg.style.height = img.naturalHeight + 'px';
    buildOverlay();
    recalcTP();
    updateSidebar();
    fitMap();
    log('<span class="log-info">Travel Tracker ready. Click the map to set current hex.</span>');
  };
  if (img.complete && img.naturalWidth) doInit();
  else img.addEventListener('load', doInit);

  // Speed / forced march inputs trigger TP recalc
  document.getElementById('inp-speed').addEventListener('input', () => { recalcTP(); updateSidebar(); });
  document.getElementById('chk-forced').addEventListener('change', () => { recalcTP(); updateSidebar(); });
  document.getElementById('chk-road').addEventListener('change', () => updateSidebar());
  document.getElementById('chk-hunter').addEventListener('change', () => updateSidebar());
  document.getElementById('chk-guide').addEventListener('change', () => updateSidebar());
  document.getElementById('chk-fire').addEventListener('change', () => {
    state.hasFire = document.getElementById('chk-fire').checked;
  });

  // Calendar sync toggle
  document.getElementById('chk-cal-sync').addEventListener('change', onCalSyncToggle);

  // Initial calendar state load (no sync, just display)
  (async () => {
    try {
      const { state: st } = await fetchState();
      calState = st;
      document.getElementById('disp-cal-date').textContent = calDateLabel(st);
      document.getElementById('disp-cal-season').textContent = calSeasonLabel(st);
    } catch(e) { /* ignore â€” calendar might not be reachable */ }
  })();
});
</script>
</body>
</html>
